openapi: 3.1.0
info:
  title: Wandering Robot API
  version: 0.1.0
paths:
  /api/status:
    get:
      summary: Get current status
      responses:
        '200':
          description: Status
          content:
            application/json:
              schema:
                type: object
  /api/mode:
    post:
      summary: Set mode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [mode]
              properties:
                mode:
                  type: string
                  enum: [AUTO, MANUAL, REMOTE]
      responses:
        '200': { description: OK }
        '400': { description: Bad request }
  /api/cmd:
    post:
      summary: Send a movement command (REMOTE mode)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  enum: [forward, backward, left, right, stop]
                speed:
                  type: number
                  minimum: 0
                  maximum: 1
                duration_ms:
                  type: integer
                  minimum: 1
                duration_s:
                  type: number
                  minimum: 0.001
      responses:
        '204': { description: Accepted }
        '400': { description: Bad request }
  /api/config:
    get:
      summary: Get defaults/overrides/effective config
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  defaults:
                    $ref: '#/components/schemas/ConfigMap'
                  overrides:
                    $ref: '#/components/schemas/ConfigMap'
                  effective:
                    $ref: '#/components/schemas/ConfigMap'
    patch:
      summary: Set overrides (uppercase keys only)
      description: |
        Provide a JSON object of overrides for uppercase config keys. Only documented keys are accepted.
        Values are validated for type and reasonable bounds. Unknown keys are ignored.
        The resulting `effective` map applies `overrides` on top of `defaults`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                overrides:
                  $ref: '#/components/schemas/ConfigOverrides'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  defaults:
                    $ref: '#/components/schemas/ConfigMap'
                  overrides:
                    $ref: '#/components/schemas/ConfigMap'
                  effective:
                    $ref: '#/components/schemas/ConfigMap'
  /api/config/overrides:
    delete:
      summary: Clear overrides
      responses:
        '204': { description: OK }
  /events:
    get:
      summary: Server Sent Events stream
      responses:
        '200': { description: SSE stream }

components:
  schemas:
    ConfigMap:
      type: object
      additionalProperties: true
      description: Map of configuration keys to values.
    ConfigOverrides:
      type: object
      additionalProperties: false
      description: Allowed override keys and their types.
      properties:
        # Timing & Speeds (seconds and unitless speeds 0..1)
        TICK_S:
          type: number
          description: Discrete step duration (seconds)
          example: 0.5
        MOVE_TICK_S:
          type: number
          description: Forward/backward step duration (seconds)
          example: 0.5
        TURN_TICK_S:
          type: number
          description: Left/right step duration (seconds)
          example: 0.5
        FORWARD_SPD:
          type: number
          minimum: 0
          maximum: 1
          description: Forward speed (0..1)
          example: 0.4
        TURN_SPD:
          type: number
          minimum: 0
          maximum: 1
          description: Turn speed (0..1)
          example: 0.2
        BACK_SPD:
          type: number
          minimum: 0
          maximum: 1
          description: Backward speed (0..1)
          example: 0.2
        # Distance Heuristics
        STOP_CM:
          type: number
          description: Distance threshold to consider too close (cm)
          example: 15
        CLEAR_CM:
          type: number
          description: Distance threshold considered clear (cm)
          example: 30
        MAX_DISTANCE_M:
          type: number
          description: Maximum measurable distance (meters)
          example: 2.5
        SAMPLES_PER_READ:
          type: integer
          minimum: 1
          description: Sensor samples per measurement
          example: 3
        # Stuck detection
        STUCK_DELTA_CM:
          type: number
          description: Min spread across last steps to avoid stuck (cm)
          example: 5
        STUCK_STEPS:
          type: integer
          minimum: 1
          description: Window length for stuck detection (ticks)
          example: 4
        BACK_TICKS:
          type: integer
          minimum: 0
          description: Number of ticks to back up when stuck
          example: 3
        NUDGE_TICKS:
          type: integer
          minimum: 0
          description: Number of ticks to turn after backing up
          example: 1
        STUCK_COOLDOWN_STEPS:
          type: integer
          minimum: 0
          description: Cooldown ticks after stuck routine
          example: 4
        # Web/IO (advanced)
        DASHBOARD_PORT:
          type: integer
          minimum: 1
          maximum: 65535
          description: Dashboard HTTP port
          example: 8000


